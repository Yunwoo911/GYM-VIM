{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .profile-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: auto;
    }

    .profile-container img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
    }

    .upload-button {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background-color: #8FCBDD;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .upload-button input[type="file"] {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
    <h1>Update Profile</h1>
    <form id="profile-update-form" method="post" action="{% url 'profile_update' %}" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <div class="profile-container mb-3">
            {% if user.user_image %}
                <img id="image_preview" src="{{ user.user_image.url }}" alt="Profile Image"/>
            {% else %}
                <img id="image_preview" src="{% static 'default.png' %}" alt="Profile Image"/>
            {% endif %}
            <label class="upload-button" for="id_user_image">
                <i class="fa fa-camera"></i>
                <input type="file" name="user_image" id="id_user_image" class="form-control" onchange="previewImage(event)">
            </label>
        </div>
            {{ form.user_image }}
            {{ form.user_image.errors }}
        </div>
        <div class="form-group">
            {{ form.username.label_tag }}
            {{ form.username }}
            {{ form.username.errors }}
        </div>
        <div class="form-group">
            {{ form.email.label_tag }}
            {{ form.email }}
            {{ form.email.errors }}
        </div>
        <div class="form-group">
            {{ form.phone1.label_tag }}
            {{ form.phone1 }}
            {{ form.phone1.errors }}
        </div>
        <div class="form-group">
            {{ form.phone2.label_tag }}
            {{ form.phone2 }}
            {{ form.phone2.errors }}
        </div>
        <div class="form-group">
            {{ form.phone3.label_tag }}
            {{ form.phone3 }}
            {{ form.phone3.errors }}
        </div>
        <div class="form-group">
            {{ form.birth.label_tag }}
            {{ form.birth }}
            {{ form.birth.errors }}
        </div>
        <div class="form-group">
            {{ form.address.label_tag }}
            {{ form.address }}
            {{ form.address.errors }}
        </div>
        <div class="form-group">
            {{ form.detail_address.label_tag }}
            {{ form.detail_address }}
            {{ form.detail_address.errors }}
        </div>
        <div class="form-group">
            {{ form.nickname.label_tag }}
            {{ form.nickname }}
            {{ form.nickname.errors }}
        </div>
        <div class="form-group">
            {{ form.gender.label_tag }}
            {{ form.gender }}
            {{ form.gender.errors }}
        </div>
        <button type="submit" class="btn btn-primary">저장하기</button>
    </form>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('profile-update-form');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
            form.addEventListener('submit', function (event) {
                event.preventDefault();
    
                const formData = new FormData(form);
    
                fetch('{% url "profile_update_api" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                    },
                    body: formData,
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Success:', data);
                    // 성공 시 처리 (예: 알림 표시 또는 페이지 리다이렉트)
                    alert('프로필이 성공적으로 업데이트되었습니다.');
                    window.location.href = '{% url "profile" %}';
                })
                .catch((error) => {
                    console.error('Error:', error);
                    alert('프로필 업데이트 중 오류가 발생했습니다.');
                });
            });
        });
    </script>
    
    <script>
        function previewImage(event) {
            var reader = new FileReader();
            reader.onload = function () {
                var output = document.getElementById('image_preview');
                output.src = reader.result;
                output.style.display = 'block';
            };
            if (event.target.files.length > 0) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }
    
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = ''; // 주소 변수
                    var extraAddr = ''; // 참고항목 변수
    
                    if (data.userSelectedType === 'R') {
                        addr = data.roadAddress;
                    } else {
                        addr = data.jibunAddress;
                    }
    
                    if(data.userSelectedType === 'R'){
                        if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                            extraAddr += data.bname;
                        }
                        if(data.buildingName !== '' && data.apartment === 'Y'){
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        if(extraAddr !== ''){
                            extraAddr = ' (' + extraAddr + ')';
                        }
                        document.getElementById("sample6_extraAddress").value = extraAddr;
                    } else {
                        document.getElementById("sample6_extraAddress").value = '';
                    }
    
                    document.getElementById('sample6_postcode').value = data.zonecode;
                    document.getElementById("sample6_address").value = addr;
                    document.getElementById("sample6_detailAddress").focus();
                }
            }).open();
        }
    </script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
{% endblock %}
